---
title: "CakePHP2.x ã®ãƒ†ã‚¹ãƒˆäº‹æƒ…"
emoji: "ðŸ°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["PHP", "CakePHP", "ãƒ†ã‚¹ãƒˆ"]
published: true
---

# å¯¾è±¡èª­è€…

- CakePHP2.x ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããŸã„ã®ã«å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ‰‹é †é€šã‚Šã«è©¦ã—ã¦ã‚‚ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãç’°å¢ƒã‚’ä½œã‚Œãªã„æ–¹
- CakePHP2.x ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ã«ãªã£ãŸã‘ã©ã€ã©ã†æ›¸ã‘ã°ã‚ˆã„ã®ã‹åˆ†ã‹ã‚‰ãªã„æ–¹

# æœ¬è¨˜äº‹ã®è¦ç´„

- ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’å°Žå…¥ã™ã‚‹å ´åˆã¯ [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(è‹±èªž)](https://book.cakephp.org/2/en/development/testing.html)ã‚’è¦‹ã¦ã€æ‰‹é †ã‚’é€²ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
- Fixture ã‚’ä½œæˆã™ã‚‹éš›ã¯æ‰‹å‹•ã§ä½œæˆã›ãšã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‹ bake ã‚³ãƒžãƒ³ãƒ‰ã§è‡ªå‹•ç”Ÿæˆã—ã¾ã—ã‚‡ã†
- å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ AllTestsTest ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†

# CakePHP2.x ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(æ—¥æœ¬èªž)](https://book.cakephp.org/2/ja/development/testing.html)ãŒã‚ã‚‹ã®ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ²¿ã£ã¦æ‰‹é †ã‚’é€²ã‚ã‚Œã°ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’å°Žå…¥ã§ãã¾ã™ã€‚

ãŒâ€¦ã€‚

PHP 7 ç³»ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ PHPUnit5.x ä»¥é™ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**2022/08/09 æ™‚ç‚¹ã§ã¯æ—¥æœ¬èªžãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã ã‘ã§ã¯ PHP 7 ç³»ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ãç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“â€¦ã€‚**

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(è‹±èªž)](https://book.cakephp.org/2/en/development/testing.html)ã‚’è¦‹ã¦ã€ä»¥ä¸‹ã®å¯¾å¿œã‚’ãŠã“ãªã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

> To be able to work with PHP 7, it is required to install the version 5, and you'll need to setup the autoloader, and
> work around an issue in Composer's autoloader. In your Config/bootstrap.php file add the following:

```php
// Load Composer autoload.
require APP . 'Vendor/autoload.php';

// Remove and re-prepend CakePHP's autoloader as Composer thinks it is the
// most important.
// See: http://goo.gl/kKVJO7
spl_autoload_unregister(array('App', 'load'));
spl_autoload_register(array('App', 'load'), true, true);
```

ä¸Šè¨˜å¯¾å¿œãŒå®Œäº†ã™ã‚Œã°ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’å°Žå…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ PHPUnit ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ 5 ç³»ã«ãªã£ã¦ã—ã¾ã†ã“ã¨ã§ã™ãŒã€CakePHP2.x ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ä»¥ä¸Šã€PHPUnit ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚å¤ã„ã‚‚ã®ã«ãªã‚‹ã®ã¯ä»•æ–¹ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

# CakePHP2.x ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

## CLI

åŸºæœ¬çš„ã«ã¯ CLI ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

`cake` ã‚³ãƒžãƒ³ãƒ‰ã®ã‚µãƒ–ã‚³ãƒžãƒ³ãƒ‰ã§ã‚ã‚‹ `test` ã‚’ä½¿ç”¨ã™ã‚Œã°ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```shell
php ./Console/cake.php test app Controller/AppController
```

:::message
Controller/AppControllerTest ã®ã‚ˆã†ã« Test ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹æŒ‡å®šã¯ä¸è¦ã§ã™ã€‚
:::

ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ‘ã‚¹ã‚«ãƒ«ã‚±ãƒ¼ã‚¹ã§æ›¸ãã€Test ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã•ãˆä»˜ä¸Žã—ã¦ã„ã‚Œã°ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åã¯ç‰¹ã«åˆ¶ç´„ã¯ãªã„ã§ã™ã€‚

Hoge, HogeTest ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç´ä»˜ã‹ã›ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãƒãƒžã‚Šãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€Session ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ `--stderr` ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦æŒ‡å®šã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã§ã‚³ã‚±ã¾ã™â€¦ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚æ˜Žè¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

> ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ç›¸äº’ä½œç”¨ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã¯ã€åŸºæœ¬çš„ã« --stderr ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã‚ˆã†ã« ã™ã‚‹ã¨ã†ã¾ãã„ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ headers_sent warning ã«ã‚ˆã£ã¦ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹å•é¡ŒãŒ
> è§£æ±ºã™ã‚‹ã§ã—ã‚‡ã†ã€‚

## ãƒ–ãƒ©ã‚¦ã‚¶

https://book.cakephp.org/2/ja/development/testing.html#id8

ã‚„ã£ãŸã“ã¨ãŒãªã„ã®ã§ã€åˆ†ã‹ã‚‰ãªã„ã§ã™ãŒã€ä¸€å¿œã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

å€‹äººçš„ã«ã¯ã€test.php ãŒé–“é•ã£ã¦æœ¬ç•ªã§ã‚‚è¦‹ã‚Œã¡ã‚ƒã†ã¿ãŸã„ãªã“ã¨ãŒæ€–ã„ã®ã§ã€ã‚„ã‚‰ãªã„æ–¹ãŒè‰¯ã•ãã†ãªæ°—ãŒã—ã¦ã„ã¾ã™â€¦ã€‚

## å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã¨ãã€PR ã‚’ä½œæˆã™ã‚‹ã¨ããªã©ã§è‡ªåˆ†ã®å¤‰æ›´ãŒä»–ã®ãƒ†ã‚¹ãƒˆã®æŒ¯ã‚‹èˆžã„ã«å½±éŸ¿ã—ã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹ãŸã‚ã«å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸã„ã¨æ€ã†çž¬é–“ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ç”¨ã® `AllTestsTest` ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```php
class AllTestsTest extends CakeTestSuite {
    public static function suite() {
        $suite = new CakeTestSuite('All tests');
        $suite->addTestDirectoryRecursive(TESTS . 'Case');
        return $suite;
    }
}
```

AllTestsTest ã‚’ä½œæˆå¾Œã« `cake test app AllTests` ã¨å®Ÿè¡Œã™ã‚‹ã“ã¨ã§å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œå¯èƒ½ã§ã™ã€‚

# CakePHP2.x ã§ã®ãƒ†ã‚¹ãƒˆè¨˜è¿°æ–¹æ³•

## Fixture ã®ä½œæˆæ–¹æ³•

CakePHP2.x ã§ã¯ Fixture ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Fixture ã®ä½œæˆæ–¹æ³•ã¨ã—ã¦ã¯3ç¨®é¡žã‚ã‚Šã¾ã™ã€‚

1. æ—¢å­˜ã®ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’èª­ã¿å–ã‚Šã€ãƒ†ã‚¹ãƒˆç”¨ DB ã«ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã™ã‚‹æ–¹æ³•

```php
class ArticleFixture extends CakeTestFixture {
    public $import = 'Article';
}
```

2. å‚ç…§ã™ã‚‹ DB ã‚’æŒ‡å®šã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’èª­ã¿å–ã‚‹

```php
class ArticleFixture extends CakeTestFixture {
    public $import = array('table' => 'articles', 'connection' => 'other');
}
```

3. $fields ã‚’å®šç¾©ã™ã‚‹

```php
class ArticleFixture extends CakeTestFixture {

    public $fields = array(
        'id' => array('type' => 'integer', 'key' => 'primary'),
        'title' => array('type' => 'string', 'length' => 255, 'null' => false),
        'body' => 'text',
        'published' => array('type' => 'integer', 'default' => '0', 'null' => false),
        'created' => 'datetime',
        'updated' => 'datetime'
    );

    public function init() {
        $this->records = array(
            array(
                'id' => 1,
                'title' => 'First Article',
                'body' => 'First Article Body',
                'published' => '1',
                'created' => date('Y-m-d H:i:s'),
                'updated' => date('Y-m-d H:i:s'),
            ),
        );
        parent::init();
    }
}
```

$fields ã‚’ä½œæˆã™ã‚‹ã®ã¯äººé–“ãŒã‚„ã‚‹ã“ã¨ã§ã¯ãªã„ã®ã§ã€ãƒ„ãƒ¼ãƒ«ã«ä»»ã›ã¾ã—ã‚‡ã†ã€‚

`cake` ã‚³ãƒžãƒ³ãƒ‰ã®ã‚µãƒ–ã‚³ãƒžãƒ³ãƒ‰ã§ã‚ã‚‹ `bake` ã‚’ä½¿ç”¨ã™ã‚Œã°ã€ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ $fields ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Controller ã®ãƒ†ã‚¹ãƒˆ

`testAction` ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

```php
public function testAdding() {
    $data = array(
        'Post' => array(
            'title' => 'New post',
            'body' => 'Secret sauce'
        )
    );
    $this->testAction('/posts/add', array('data' => $data, 'method' => 'get'));
    // some assertions.
}
```

æ°—ã‚’ä»˜ã‘ã‚‹ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰å†…ã§ `$this->response` ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã“ã¨ã§ã™ã€‚

æ›¸ãæ›ãˆã‚’ãŠã“ãªã£ã¦ã„ãªã„ã¨ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸ MockController ã®å€¤ãŒ response ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ 200 ã® body ã‚‚ null ã§ã™ã€‚

## Model ã®ãƒ†ã‚¹ãƒˆ

```php
App::uses('Article', 'Model');

class ArticleTest extends CakeTestCase {
    public $fixtures = array('app.article');

    public function setUp() {
        parent::setUp();
        $this->Article = ClassRegistry::init('Article');
    }

    public function testPublished() {
        $result = $this->Article->published(array('id', 'title'));
        $expected = array(
            array('Article' => array('id' => 1, 'title' => 'First Article')),
            array('Article' => array('id' => 2, 'title' => 'Second Article')),
            array('Article' => array('id' => 3, 'title' => 'Third Article'))
        );

        $this->assertEquals($expected, $result);
    }
}
```

`App::uses('xxx', 'Model');` ã®å®£è¨€ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«æ³¨æ„ã§ã™ã€‚

# æ‰€æ„Ÿ

2022å¹´ã«ã‚‚ãªã£ã¦ CakePHP2 ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯å°‘ãªã„ã¨æ€ã„ã¾ã™ãŒã€ã“ã®è¨˜äº‹ãŒèª°ã‹ã®å½¹ã«ç«‹ã¦ã°å¹¸ã„ã§ã™ã€‚

æŽ¡ç”¨ã•ã‚Œã¦ã„ã‚‹è¨€èªžã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒã©ã‚“ãªã‚‚ã®ã§ã‚ã£ã¦ã‚‚ä¿¡é ¼ã§ãã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ã€ã„ã–è¨€èªžã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ç½®ãæ›ãˆãŸã„ã¨ãªã£ãŸå ´åˆã®é“æ¨™ã«ãªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

> ãƒ†ã‚¹ãƒˆã®ãªã„ã‚³ãƒ¼ãƒ‰ã¯æ‚ªã„ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ã€‚
> ã©ã‚Œã ã‘ã†ã¾ãæ›¸ã‹ã‚Œã¦ã„ã‚‹ã‹ã¯é–¢ä¿‚ãªã„ã€‚
> ã©ã‚Œã ã‘ç¾Žã—ã„ã‹ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã‹ã€ãã¡ã‚“ã¨ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã¯é–¢ä¿‚ãªã„ã€‚
> ãƒ†ã‚¹ãƒˆãŒã‚ã‚Œã°ã€æ¤œè¨¼ã—ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰ã®å‹•ãã‚’ç´ æ—©ãå¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
> ãƒ†ã‚¹ãƒˆãŒãªã‘ã‚Œã°ã€ã‚³ãƒ¼ãƒ‰ãŒè‰¯ããªã£ã¦ã„ã‚‹ã®ã‹æ‚ªããªã£ã¦ã„ã‚‹ã®ã‹ãŒæœ¬å½“ã«ã¯ã‚ã‹ã‚‰ãªã„ã€‚
>
> ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰æ”¹å–„ã‚¬ã‚¤ãƒ‰ â…µ ãƒšãƒ¼ã‚¸ã‚ˆã‚Š

